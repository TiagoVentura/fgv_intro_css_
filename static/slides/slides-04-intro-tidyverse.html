<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Introdução a Métodos Computacionais para Ciência Sociais</title>
    <meta charset="utf-8" />
    <meta name="author" content="Tiago Ventura" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/countdown/countdown.css" rel="stylesheet" />
    <script src="libs/countdown/countdown.js"></script>
    <link rel="stylesheet" href="styles.css" type="text/css" />
    <link rel="stylesheet" href="fontsrladies.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Introdução a Métodos Computacionais para Ciência Sociais
## Intro ao Tidyverse: Manipulação de Banco de Dados
### Tiago Ventura
### CPDOC-FGV

---




---

## Semana Passada

1. Introdução ao R

2. RMarkdown 

## Próximas Semanas

1. Manipulação de Bancos de Dados (dplyr)

2. Dados Tidy (tidyr)

3. Visualização (ggplot)


---

# Manipulação de Bancos de Dados

90% do nosso trabalho com dados consiste em colocar nossos dados no formato correto.. este processo envolve...

- manipular variáveis

- juntar bancos de dados

- reformatar dados

- limpeza... 

Para todas esta tarefas, usaremos os pacotes da família `tidyverse`

---

# Tidyverse

O `tidyverse` é uma família de pacotes em R desenvolvidos  de forma integrada e compartilhando uma mesma filosofia de design, gramática e estruturas de dados subjacentes.

O objetivo do `tidyverse` é prover um conjunto integrado de ferramentas para o uso do R como linguagem em Ciência de Dados. Estes são os principais pacotes do `tidyverse`:

- `dplyr`: para manipulação de dados.

- `ggplot2`: para visualização de dados.

- `tidyr`: para preparar seus dados para análise. 

- `purrr`: para otimizar seu código e para programação funcional.

- `readr`: para abrir e organizar os dados. 

- `stringr`: para manipulação de objetos de texto. 

- `forcats`: para manipulação da classe fatores. 

---
# Vantagens do Tidyverse ... em gif

.center[

&lt;img src="https://media.giphy.com/media/elUGwgiPOdq7e/giphy.gif" width="60%" /&gt;

]

---

# Vantagens do Tidyverse ... em palavras.

- O `tidyverse` facilita substancialmente as tarefas de análise de dados quando comparado com códigos do  R básico. 

- Aumenta substancialmente quão legível seu código parece.

- Manipulação, visualização e modelagem estão integradas no tidyverse. 

- É amplamente utilizado na comunidade de R. Portanto, provavelmente você precisa aprender para ler códigos de outros colegas.



---
class:middle, center

# Introdução ao Tidyverse

---
## Instalação


```r
install.packages("tidyverse")
```


```r
library(tidyverse)
```


---

## Tibbles. 


O objeto fundamental do `tidyverse` são bancos de dados.

O `tidyverse` usa objetos da classe "tibbles" para definir seus bancos de dados ao invés do tradicional data.frame que aprendemos semana passada. 

Tibbles são exatamente iguais aos data.frames em sua estrutura básica.  No entanto, tibbles possuem alguns ajustes - mais visuais -  para facilitar seu uso. 

---

## Criando Tibbles. 

--
.pull-left[

```r
# Classe do Banco de Dados mtcars
class(mtcars)
```

```
## [1] "data.frame"
```

```r
# Converte para tibbles
mtcars_tib &lt;- as_tibble(mtcars)
mtcars_tib
```

```
## # A tibble: 32 x 11
##      mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  21       6  160    110  3.9   2.62  16.5     0     1     4     4
##  2  21       6  160    110  3.9   2.88  17.0     0     1     4     4
##  3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1
##  4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1
##  5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2
##  6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1
##  7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4
##  8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2
##  9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2
## 10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4
## # … with 22 more rows
```
]

--

.pull-right[

```r
tibble(a=c("Tiago", "Ventura"), 
       b=c("nome", "sobrenome"))
```

```
## # A tibble: 2 x 2
##   a       b        
##   &lt;chr&gt;   &lt;chr&gt;    
## 1 Tiago   nome     
## 2 Ventura sobrenome
```

]

--

---

## Pipe.

.pull-left[
&lt;img src="figs/pipe.jpg" width="60%" /&gt;
]

.pull-right[

O uso de pipes `%&gt;%` é uma peça fundamental no funcionamento dos pacotes do `tidyverse`. As principais vantagens do pipe:

- Concatenar as funções do seu código. 

- Evitar objetos intermediários.

- Tornar os códigos mais intuitivos. 

- Evita múltiplos parentesis. 
]
---

### O R funciona de dentro para fora:


```r
# R
x &lt;- c(1:10)
round(exp(sqrt(mean(x))), 1)
```

```
## [1] 10.4
```

### O Pipe


```r
x %&gt;%
  mean() %&gt;%
  sqrt() %&gt;%
  exp() %&gt;%
  round(1) 
```

```
## [1] 10.4
```

---
# Notas importantes sobre os pipes. 

**1. Os pipes sempre devem ser usados para conectar funções e seus outputs.**


```r
# Não rode este código.
x %&gt;%
  funcao1(arg1=x) %&gt;%
  funcao2(arg=output_da_funcao1)
```

**Exemplo:**


```r
sample(1:1000, 500, replace=TRUE) %&gt;%
  density() %&gt;% # funcao 1.
  plot() # função 2. 
```

&lt;img src="slides-04-intro-tidyverse_files/figure-html/unnamed-chunk-10-1.png" width="30%" /&gt;

---

**2. O input sempre pode ser omitido, ou representados pelo atalho `.`**


```r
sample(1:1000, 500, replace=TRUE) %&gt;%
  density(.) %&gt;% # funcao 1.
  plot(.) # função 2. 
```

![](slides-04-intro-tidyverse_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;

---

**3. Os resultados do pipe não são salvos imediatamente. Você precisa atribuir à um novo objeto.** 


```r
grafico &lt;- sample(1:1000, 500, replace=TRUE) %&gt;%
              density(.) %&gt;% # funcao 1.
              plot(.) # função 2. 
```

![](slides-04-intro-tidyverse_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;

---

## Desafio. 

Reescreva o código abaixo utilizando o `%&gt;%`.


```r
library(tidyverse)

x &lt;- "cpdoc"
x &lt;- str_to_upper(x)
x &lt;- str_c(x, "-FGV")
x &lt;- str_to_title(x)
x
```

```
## [1] "Cpdoc-Fgv"
```

<div class="countdown" id="timer_603bcf61" style="right:0;bottom:0;margin:5%;padding:10px;font-size:3em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">03</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

--

```r
library(tidyverse)

x  %&gt;%
  str_to_upper() %&gt;%
  str_c("-FGV") %&gt;%
  str_to_title()
```

```
## [1] "Cpdoc-Fgv-Fgv"
```
--

---
class: middle, center, inverse

# Manipulação de dados com `dplyr`.

---

## Dados Eleitorais: cepespR


```r
if (!require("devtools")) install.packages("devtools")
devtools::install_github("Cepesp-Fgv/cepesp-r") 
```


```r
library(cepespR)
library(tidyverse)

pres_rio &lt;- get_votes(year = 2018, 
                         position = "Presidente", 
                         regional_aggregation = "Municipio", 
                         state="RJ") %&gt;%
                  as_tibble()
```

---

## Introdução ao Dplyr. 

O `dplyr` é um dos pacotes mais populares em R. 

Sua lógica é simples: suas funções fazem exatamente o que seus nomes descrevem (**verb based language**).  Estas são as funções mais úteis do `dplyr`:

.pull-left[
- `select()`: selecionar colunas.

- `filter()`: filtrar o banco de dados por linhas.

- `mutate()`: criar novas variáveis e alterar existentes.

- `arrange()`: ordenar o banco de dados.

- `group_by()`: agrupar e fazer análiser nos subgrupos. 

- `summarize()`: sumariza os dados por subgroups. 
]

.pull-right[


Todas essas funções seguem as mesmas características:

- O input é sempre um banco de dados. 

- O banco de dados é sempre o primeiro argumento. 

- Os argumentos seguintes acessão colunas dos bancos de dados diretamente, sem aspas. 

- O output é sempre um novo banco de dados. 

]

---

**Algumas outras funções menos utilizadas**:

- `count()`: contar número de observações por subgrupos.

- `distinct()`: eliminar repetições.

- `n():` conta quantas observações há em dados agrupados.

- `sample_n():` Selecion n amostras do seu banco de dadosl

- `glimpse():` Fornece um sumário dos seus dados. 

- `top_n():` Seleciona por linhas de acordo com o rank das variáveis.

- `slice()`: filtra seu banco de dados por posições. 

---

# Select: Seleciona Colunas. 


&lt;img src="figs/select.png" width="80%" /&gt;

---
## Uso Básico


```r
pres_rio %&gt;% # Dados
  select(ANO_ELEICAO, SIGLA_UE, NOME_MUNICIPIO, COD_MUN_IBGE) # colunas
```

```
## # A tibble: 1,374 x 4
##    ANO_ELEICAO SIGLA_UE NOME_MUNICIPIO COD_MUN_IBGE
##          &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;                 &lt;int&gt;
##  1        2018 BR       Angra dos Reis      3300100
##  2        2018 BR       Angra dos Reis      3300100
##  3        2018 BR       Angra dos Reis      3300100
##  4        2018 BR       Angra dos Reis      3300100
##  5        2018 BR       Angra dos Reis      3300100
##  6        2018 BR       Angra dos Reis      3300100
##  7        2018 BR       Angra dos Reis      3300100
##  8        2018 BR       Angra dos Reis      3300100
##  9        2018 BR       Angra dos Reis      3300100
## 10        2018 BR       Angra dos Reis      3300100
## # … with 1,364 more rows
```

---

## Reordenando Colunas


```r
pres_rio %&gt;% # Dados
  # seleciona colunas
  select(QTDE_VOTOS, ANO_ELEICAO, SIGLA_UE, 
         NOME_MUNICIPIO, COD_MUN_IBGE) # colunas
```

```
## # A tibble: 1,374 x 5
##    QTDE_VOTOS ANO_ELEICAO SIGLA_UE NOME_MUNICIPIO COD_MUN_IBGE
##         &lt;int&gt;       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;                 &lt;int&gt;
##  1       8696        2018 BR       Angra dos Reis      3300100
##  2      13204        2018 BR       Angra dos Reis      3300100
##  3        565        2018 BR       Angra dos Reis      3300100
##  4         34        2018 BR       Angra dos Reis      3300100
##  5      59499        2018 BR       Angra dos Reis      3300100
##  6        662        2018 BR       Angra dos Reis      3300100
##  7        349        2018 BR       Angra dos Reis      3300100
##  8         32        2018 BR       Angra dos Reis      3300100
##  9        998        2018 BR       Angra dos Reis      3300100
## 10       1909        2018 BR       Angra dos Reis      3300100
## # … with 1,364 more rows
```

---

## Renomeando Colunas


```r
pres_rio %&gt;% 
  # seleciona colunas com novos nomes. 
  select(votos=QTDE_VOTOS, 
         ano=ANO_ELEICAO, 
         pais=SIGLA_UE, 
         mun=NOME_MUNICIPIO, 
         cod=COD_MUN_IBGE) # colunas
```

```
## # A tibble: 1,374 x 5
##    votos   ano pais  mun                cod
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;            &lt;int&gt;
##  1  8696  2018 BR    Angra dos Reis 3300100
##  2 13204  2018 BR    Angra dos Reis 3300100
##  3   565  2018 BR    Angra dos Reis 3300100
##  4    34  2018 BR    Angra dos Reis 3300100
##  5 59499  2018 BR    Angra dos Reis 3300100
##  6   662  2018 BR    Angra dos Reis 3300100
##  7   349  2018 BR    Angra dos Reis 3300100
##  8    32  2018 BR    Angra dos Reis 3300100
##  9   998  2018 BR    Angra dos Reis 3300100
## 10  1909  2018 BR    Angra dos Reis 3300100
## # … with 1,364 more rows
```

---

## Salvando Novo Banco. 


```r
rio_reduzido &lt;- pres_rio %&gt;% # Dados
                  # seleciona colunas com novos nomes. 
                  select(votos=QTDE_VOTOS, 
                         ano=ANO_ELEICAO, 
                         pais=SIGLA_UE, 
                         mun=NOME_MUNICIPIO, 
                         cod=COD_MUN_IBGE) # colunas
```

---

## Atalhos para Uso do Select. 

- `contains()` - Extrai colunas que contêm determinado texto.

- `starts_with()` - Extrai colunas que inicia com determinado texto.

- `ends_with()` - Extrai colunas que termina com determinado texto. 

- `everything()` - Extrai todas as colunas restantes.

---

## Exemplos


```r
pres_rio %&gt;%
  # seleciona colunas onde NOME aparece
  select(contains("NOME"))
```

```
## # A tibble: 1,374 x 5
##    NOME_MACRO NOME_UF        NOME_MESO      NOME_MICRO          NOME_MUNICIPIO
##    &lt;chr&gt;      &lt;chr&gt;          &lt;chr&gt;          &lt;chr&gt;               &lt;chr&gt;         
##  1 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  2 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  3 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  4 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  5 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  6 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  7 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  8 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
##  9 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
## 10 Sudeste    Rio de Janeiro Sul Fluminense Baía da Ilha Grande Angra dos Reis
## # … with 1,364 more rows
```



```r
pres_rio %&gt;%
  # seleciona colunas que terminam com UF e 
  # todas as outras colunas restantes
  select(ends_with("UF"), everything())
```

```
## # A tibble: 1,374 x 19
##    UF    NOME_UF ANO_ELEICAO SIGLA_UE NUM_TURNO DESCRICAO_ELEIC… CODIGO_CARGO DESCRICAO_CARGO NUMERO_CANDIDATO
##    &lt;chr&gt; &lt;chr&gt;         &lt;int&gt; &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;                   &lt;int&gt; &lt;chr&gt;                      &lt;int&gt;
##  1 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    12
##  2 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    13
##  3 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    15
##  4 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    16
##  5 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    17
##  6 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    18
##  7 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    19
##  8 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    27
##  9 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    30
## 10 RJ    Rio de…        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    45
## # … with 1,364 more rows, and 10 more variables: CODIGO_MACRO &lt;int&gt;, NOME_MACRO &lt;chr&gt;, CODIGO_MESO &lt;int&gt;,
## #   NOME_MESO &lt;chr&gt;, CODIGO_MICRO &lt;int&gt;, NOME_MICRO &lt;chr&gt;, COD_MUN_TSE &lt;int&gt;, COD_MUN_IBGE &lt;int&gt;,
## #   NOME_MUNICIPIO &lt;chr&gt;, QTDE_VOTOS &lt;int&gt;
```

---

## Filter: Filtra Linhas por Condições Lógicas. 


      filter(data, coluna=="a")


&lt;img src="figs/filter.png" width="80%" /&gt;

---

## Filter: Uso Básico



```r
pres_rio %&gt;%
  # filtra casos ondem partido igual a 17.
  filter(NUMERO_CANDIDATO==17) %&gt;%
  # seleciona
  select(DESCRICAO_CARGO, NUMERO_CANDIDATO, QTDE_VOTOS, NOME_MUNICIPIO)
```

```
## # A tibble: 184 x 4
##    DESCRICAO_CARGO NUMERO_CANDIDATO QTDE_VOTOS NOME_MUNICIPIO    
##    &lt;chr&gt;                      &lt;int&gt;      &lt;int&gt; &lt;chr&gt;             
##  1 PRESIDENTE                    17      59499 Angra dos Reis    
##  2 PRESIDENTE                    17       4366 Aperibé           
##  3 PRESIDENTE                    17      44108 Araruama          
##  4 PRESIDENTE                    17       3816 Areal             
##  5 PRESIDENTE                    17      13028 Armação dos Búzios
##  6 PRESIDENTE                    17      13342 Arraial do Cabo   
##  7 PRESIDENTE                    17      27178 Barra do Piraí    
##  8 PRESIDENTE                    17      55972 Barra Mansa       
##  9 PRESIDENTE                    17     138676 Belford Roxo      
## 10 PRESIDENTE                    17       8077 Bom Jardim        
## # … with 174 more rows
```

---

## Filter: Multiplas Condições


```r
pres_rio %&gt;%
  # filtra usando or
  filter(NUMERO_CANDIDATO==17 | NUMERO_CANDIDATO==13, # or
  #filtra usando and
         NOME_MUNICIPIO=="Rio de Janeiro") %&gt;% # and
  #selecion
  select(DESCRICAO_CARGO, NUMERO_CANDIDATO, QTDE_VOTOS, NOME_MUNICIPIO)
```

```
## # A tibble: 4 x 4
##   DESCRICAO_CARGO NUMERO_CANDIDATO QTDE_VOTOS NOME_MUNICIPIO
##   &lt;chr&gt;                      &lt;int&gt;      &lt;int&gt; &lt;chr&gt;         
## 1 PRESIDENTE                    13     398033 Rio de Janeiro
## 2 PRESIDENTE                    17    1930657 Rio de Janeiro
## 3 PRESIDENTE                    13    1105393 Rio de Janeiro
## 4 PRESIDENTE                    17    2179896 Rio de Janeiro
```

---

## Arrange: Ordena Linhas por Colunas.

    arrange(data, coluna)

&lt;img src="figs/arrange.png" width="80%" /&gt;

---

## Arrange: Uso Básico:
  

```r
pres_rio %&gt;%
  # filtra pelas linhas
  filter(NUMERO_CANDIDATO==13) %&gt;% 
  # seleciona
  select(DESCRICAO_CARGO, NUMERO_CANDIDATO,
         QTDE_VOTOS, NOME_MUNICIPIO) %&gt;%
  # ordena de forma crescente
  arrange(QTDE_VOTOS)
```

```
## # A tibble: 184 x 4
##    DESCRICAO_CARGO NUMERO_CANDIDATO QTDE_VOTOS NOME_MUNICIPIO               
##    &lt;chr&gt;                      &lt;int&gt;      &lt;int&gt; &lt;chr&gt;                        
##  1 PRESIDENTE                    13        830 São José do Vale do Rio Preto
##  2 PRESIDENTE                    13       1111 Areal                        
##  3 PRESIDENTE                    13       1115 Santa Maria Madalena         
##  4 PRESIDENTE                    13       1129 Aperibé                      
##  5 PRESIDENTE                    13       1152 São José de Ubá              
##  6 PRESIDENTE                    13       1224 Macuco                       
##  7 PRESIDENTE                    13       1241 Varre-Sai                    
##  8 PRESIDENTE                    13       1342 Italva                       
##  9 PRESIDENTE                    13       1448 São Sebastião do Alto        
## 10 PRESIDENTE                    13       1455 Duas Barras                  
## # … with 174 more rows
```

---


## Arrange: Decrescente    



```r
pres_rio %&gt;%
  # filtra pelas linhas
  filter(NUMERO_CANDIDATO==13) %&gt;% 
  # seleciona variáveis
  select(DESCRICAO_CARGO, NUMERO_CANDIDATO, 
         QTDE_VOTOS, NOME_MUNICIPIO) %&gt;%
  # ordena em valores descrecentes
  arrange(desc(QTDE_VOTOS))
```

```
## # A tibble: 184 x 4
##    DESCRICAO_CARGO NUMERO_CANDIDATO QTDE_VOTOS NOME_MUNICIPIO       
##    &lt;chr&gt;                      &lt;int&gt;      &lt;int&gt; &lt;chr&gt;                
##  1 PRESIDENTE                    13    1105393 Rio de Janeiro       
##  2 PRESIDENTE                    13     398033 Rio de Janeiro       
##  3 PRESIDENTE                    13     149075 São Gonçalo          
##  4 PRESIDENTE                    13     136240 Duque de Caxias      
##  5 PRESIDENTE                    13     110820 Nova Iguaçu          
##  6 PRESIDENTE                    13     105606 Niterói              
##  7 PRESIDENTE                    13      80858 São Gonçalo          
##  8 PRESIDENTE                    13      79838 Campos dos Goytacazes
##  9 PRESIDENTE                    13      77504 Duque de Caxias      
## 10 PRESIDENTE                    13      70499 São João de Meriti   
## # … with 174 more rows
```

---

## Mutate: Adiciona uma nova coluna. 

    mutate(data, nome_nova_coluna=valores_nova_coluna)

&lt;img src="figs/mutate.png" width="80%" /&gt;

---

### Mutate: Uso Básico:


```r
pres_rio %&gt;%
  # cria variável com estado e cidade
  mutate(estado_cidade=paste(NOME_MUNICIPIO, "-", NOME_UF)) %&gt;%
  #seleciona para visualizar
  select(NOME_MUNICIPIO, NOME_UF, estado_cidade)
```

```
## # A tibble: 1,374 x 3
##    NOME_MUNICIPIO NOME_UF        estado_cidade                  
##    &lt;chr&gt;          &lt;chr&gt;          &lt;chr&gt;                          
##  1 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  2 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  3 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  4 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  5 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  6 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  7 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  8 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
##  9 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
## 10 Angra dos Reis Rio de Janeiro Angra dos Reis - Rio de Janeiro
## # … with 1,364 more rows
```

---

### Mutate: Condicionais


```r
pres_rio %&gt;%
  # cria variável usando condicionais
  mutate(estado_sigla=ifelse(NOME_UF=="Rio de Janeiro", "RJ", NA), 
  # concatena nova variável com cidade
         estado_cidade=paste(estado_sigla, "-", NOME_MUNICIPIO)) %&gt;%
  #selectiona
  select(NOME_UF, NOME_MUNICIPIO, estado_sigla, everything())
```

```
## # A tibble: 1,374 x 21
##    NOME_UF NOME_MUNICIPIO estado_sigla ANO_ELEICAO SIGLA_UE NUM_TURNO DESCRICAO_ELEIC… CODIGO_CARGO DESCRICAO_CARGO
##    &lt;chr&gt;   &lt;chr&gt;          &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;                   &lt;int&gt; &lt;chr&gt;          
##  1 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  2 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  3 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  4 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  5 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  6 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  7 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  8 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
##  9 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
## 10 Rio de… Angra dos Reis RJ                  2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE     
## # … with 1,364 more rows, and 12 more variables: NUMERO_CANDIDATO &lt;int&gt;, CODIGO_MACRO &lt;int&gt;, NOME_MACRO &lt;chr&gt;,
## #   UF &lt;chr&gt;, CODIGO_MESO &lt;int&gt;, NOME_MESO &lt;chr&gt;, CODIGO_MICRO &lt;int&gt;, NOME_MICRO &lt;chr&gt;, COD_MUN_TSE &lt;int&gt;,
## #   COD_MUN_IBGE &lt;int&gt;, QTDE_VOTOS &lt;int&gt;, estado_cidade &lt;chr&gt;
```

---

### Mutate: Operações Matemáticas. 


```r
pres_rio %&gt;%
  # log dos votos
  mutate(log_votos=log(QTDE_VOTOS)) %&gt;%
  # seleciona
  select(QTDE_VOTOS, log_votos)
```

```
## # A tibble: 1,374 x 2
##    QTDE_VOTOS log_votos
##         &lt;int&gt;     &lt;dbl&gt;
##  1       8696      9.07
##  2      13204      9.49
##  3        565      6.34
##  4         34      3.53
##  5      59499     11.0 
##  6        662      6.50
##  7        349      5.86
##  8         32      3.47
##  9        998      6.91
## 10       1909      7.55
## # … with 1,364 more rows
```

---

## Group_by + Summarize. 

&lt;img src="figs/group_by.png" width="60%" /&gt;

---

### Group_by

O primeiro passo é agrupar de acordo com a variável de nosso interesse. Não altera o banco em nada, visível. 


```r
pres_rio %&gt;%
  # agrupando por candidato presidencial: 
  group_by(NUMERO_CANDIDATO) 
```

```
## # A tibble: 1,374 x 19
## # Groups:   NUMERO_CANDIDATO [13]
##    ANO_ELEICAO SIGLA_UE NUM_TURNO DESCRICAO_ELEIC… CODIGO_CARGO DESCRICAO_CARGO NUMERO_CANDIDATO CODIGO_MACRO
##          &lt;int&gt; &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;                   &lt;int&gt; &lt;chr&gt;                      &lt;int&gt;        &lt;int&gt;
##  1        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    12            3
##  2        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    13            3
##  3        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    15            3
##  4        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    16            3
##  5        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    17            3
##  6        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    18            3
##  7        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    19            3
##  8        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    27            3
##  9        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    30            3
## 10        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    45            3
## # … with 1,364 more rows, and 11 more variables: NOME_MACRO &lt;chr&gt;, UF &lt;chr&gt;, NOME_UF &lt;chr&gt;, CODIGO_MESO &lt;int&gt;,
## #   NOME_MESO &lt;chr&gt;, CODIGO_MICRO &lt;int&gt;, NOME_MICRO &lt;chr&gt;, COD_MUN_TSE &lt;int&gt;, COD_MUN_IBGE &lt;int&gt;,
## #   NOME_MUNICIPIO &lt;chr&gt;, QTDE_VOTOS &lt;int&gt;
```

---

## Summarize.

&lt;img src="figs/summarize.png" width="60%" /&gt;

---

## Summarize: Uso básico.



```r
pres_rio %&gt;%
  # Somente primeiro turno 
  filter(NUM_TURNO==1) %&gt;%
  # agrupando por candidato presidencial
  group_by(NUMERO_CANDIDATO) %&gt;%
  # Somando os votos em todo o estado.
  summarise(voto_estado=sum(QTDE_VOTOS)) %&gt;%
  # Ordena
  arrange(desc(voto_estado))
```

```
## # A tibble: 13 x 2
##    NUMERO_CANDIDATO voto_estado
##               &lt;int&gt;       &lt;int&gt;
##  1               17     5107735
##  2               12     1300292
##  3               13     1255425
##  4               51      211444
##  5               45      208325
##  6               30      139208
##  7               18      130794
##  8               15       77333
##  9               50       57846
## 10               19       41544
## 11               16        6005
## 12               27        4636
## 13               54        2806
```

---

class:center, middle, alert

### o summarize transforma múltiplas linhas em uma para cada subgrupo

---

### Mais Exemplos

**Quem ganhou no Rio de Janeiro no Segundo Turno?**


```r
pres_rio %&gt;%
  # Somente primeiro turno 
  filter(NUM_TURNO==2) %&gt;%
  # agrupando por candidato presidencial
  group_by(NUMERO_CANDIDATO) %&gt;%
  # Somando os votos em todo o estado.
  summarise(voto_estado=sum(QTDE_VOTOS)) %&gt;%
  # Ordena
  arrange(desc(voto_estado))
```

```
## # A tibble: 2 x 2
##   NUMERO_CANDIDATO voto_estado
##              &lt;int&gt;       &lt;int&gt;
## 1               17     5669059
## 2               13     2673386
```
---

**Total de Votos por Município**


```r
pres_rio %&gt;%
  # Somente primeiro turno 
  filter(NUM_TURNO==1) %&gt;%
  # agrupando por candidato presidencial
  group_by(NOME_MUNICIPIO) %&gt;%
  # Somando os votos em todo o estado.
  summarise(voto_mun=sum(QTDE_VOTOS)) 
```

```
## # A tibble: 92 x 2
##    NOME_MUNICIPIO     voto_mun
##  * &lt;chr&gt;                 &lt;int&gt;
##  1 Angra dos Reis        88316
##  2 Aperibé                6680
##  3 Araruama              64481
##  4 Areal                  6921
##  5 Armação dos Búzios    19979
##  6 Arraial do Cabo       20133
##  7 Barra do Piraí        48942
##  8 Barra Mansa           96980
##  9 Belford Roxo         226785
## 10 Bom Jardim            14090
## # … with 82 more rows
```

---

**Votos por Meso-Região**


```r
pres_rio %&gt;%
  # Somente primeiro turno 
  filter(NUM_TURNO==1) %&gt;%
  # agrupando por candidato presidencial
  group_by(NUMERO_CANDIDATO, NOME_MESO) %&gt;%
  # soma de votos por município
  summarise(voto_media=mean(QTDE_VOTOS), 
            voto_min=min(QTDE_VOTOS), 
            voto_max=max(QTDE_VOTOS))
```

```
## # A tibble: 78 x 5
## # Groups:   NUMERO_CANDIDATO [13]
##    NUMERO_CANDIDATO NOME_MESO                       voto_media voto_min voto_max
##               &lt;int&gt; &lt;chr&gt;                                &lt;dbl&gt;    &lt;int&gt;    &lt;int&gt;
##  1               12 Baixadas                             4769.     1157    13478
##  2               12 Centro Fluminense                    2558       403    16254
##  3               12 Metropolitana do Rio de Janeiro     35187.      702   645674
##  4               12 Noroeste Fluminense                  1393.      296     4684
##  5               12 Norte Fluminense                     6909.      798    33042
##  6               12 Sul Fluminense                       5412.      812    23860
##  7               13 Baixadas                             4409.     1574    10310
##  8               13 Centro Fluminense                    2954.     1111    10664
##  9               13 Metropolitana do Rio de Janeiro     31261.      830   398033
## 10               13 Noroeste Fluminense                  2789.     1129     8209
## # … with 68 more rows
```

---

## Desafio

### Mutate x Summarize. 


```r
pres_rio %&gt;%
  # Somente primeiro turno 
  filter(NUM_TURNO==1) %&gt;%
  # agrupando por candidato presidencial
  group_by(NUMERO_CANDIDATO) %&gt;%
  # Nova variável somando os votos em todo o estado.
  mutate(voto_estado=sum(QTDE_VOTOS))
```

```
## # A tibble: 1,190 x 20
## # Groups:   NUMERO_CANDIDATO [13]
##    ANO_ELEICAO SIGLA_UE NUM_TURNO DESCRICAO_ELEIC… CODIGO_CARGO DESCRICAO_CARGO NUMERO_CANDIDATO CODIGO_MACRO
##          &lt;int&gt; &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;                   &lt;int&gt; &lt;chr&gt;                      &lt;int&gt;        &lt;int&gt;
##  1        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    12            3
##  2        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    13            3
##  3        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    15            3
##  4        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    16            3
##  5        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    17            3
##  6        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    18            3
##  7        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    19            3
##  8        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    27            3
##  9        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    30            3
## 10        2018 BR               1 ELEIÇÃO GERAL F…            1 PRESIDENTE                    45            3
## # … with 1,180 more rows, and 12 more variables: NOME_MACRO &lt;chr&gt;, UF &lt;chr&gt;, NOME_UF &lt;chr&gt;, CODIGO_MESO &lt;int&gt;,
## #   NOME_MESO &lt;chr&gt;, CODIGO_MICRO &lt;int&gt;, NOME_MICRO &lt;chr&gt;, COD_MUN_TSE &lt;int&gt;, COD_MUN_IBGE &lt;int&gt;,
## #   NOME_MUNICIPIO &lt;chr&gt;, QTDE_VOTOS &lt;int&gt;, voto_estado &lt;int&gt;
```

---

### Praticando: 

Abra o banco de dados de candidatos a deputado federal no Rio de Janeiro. 


```r
dep_rio &lt;- get_candidates(year=2018,
                          position="Federal Deputy") %&gt;%
           as_tibble()
```


1 - Qual partido elegeu mais deputados? (3 linhas)


```r
# Dica: `data %&gt;% filter(COD_SIT_TOT_TURNO==2 | COD_SIT_TOT_TURNO==3) =  filtra somente os eleitos. 
```


2 - Qual candidato gastou mais recursos ? (2-3 linhas)


3 - Qual valor médio declarado de gastos de campanha de acordo com o gênero dos candidatos? (3 linhas)

<div class="countdown" id="timer_603bd67f" style="right:0;bottom:0;margin:5%;padding:10px;font-size:3em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">15</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>



---

# Conectando Bancos de Dados com Dplyr. 

Raramente, você encontrará um banco de dados onde todas as informações da sua pesquisa estão contidas e prontas para serem analisadas.  


Na maioria dos casos, e por boas razões, bancos de dados possuem informações distintas, e os pesquisadores precisam conectá-los com vistas a construir o material necessário para suas análises. 

Este tipo de dados conectados a partir de várias tabelas são chamados de **dados relacionais**.  

---

## Chaves (keys)

São as variáveis capazes de conectar bancos de dados.  Estas **chaves** são, ou devem ser:

- Completas. Nunca tenha missing values nas suas chaves. 

- Únicas: cada observação deve possuir uma chave distinta. Evite sempre duplicações. 


---
class: middle, center, inverse

## Joins

---

Inspirado na linguaguem **SQL**, o dplyr possui um conjunto de funções com foco em conectar bancos de dados distintos. 

Vamos criar dois bancos bem simples para entendermos como estes joins funcionam. 


```r
data1 &lt;- tibble(nome=c("A", "B", "C"), 
                value=c(10, 20, 30)) 
data2 &lt;- tibble(nome=c("A", "D", "C"), 
                value2=c(10, 50, 30))
data1
```

```
## # A tibble: 3 x 2
##   nome  value
##   &lt;chr&gt; &lt;dbl&gt;
## 1 A        10
## 2 B        20
## 3 C        30
```

```r
data2
```

```
## # A tibble: 3 x 2
##   nome  value2
##   &lt;chr&gt;  &lt;dbl&gt;
## 1 A         10
## 2 D         50
## 3 C         30
```

---

### left_join()

.pull-left[
&lt;img src="figs/left-join.gif" width="80%" /&gt;
]

.pull-right[


```r
left_join(data1, data2)
```

```
## # A tibble: 3 x 3
##   nome  value value2
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 A        10     10
## 2 B        20     NA
## 3 C        30     30
```

]
---

### inner_join()

.pull-left[
&lt;img src="figs/inner-join.gif" width="80%" /&gt;
]

.pull-right[

```r
inner_join(data1, data2)
```

```
## # A tibble: 2 x 3
##   nome  value value2
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 A        10     10
## 2 C        30     30
```
]

---

## full_join()

.pull-left[
&lt;img src="figs/full-join.gif" width="80%" /&gt;
]

.pull-right[

```r
full_join(data1, data2)
```

```
## # A tibble: 4 x 3
##   nome  value value2
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 A        10     10
## 2 B        20     NA
## 3 C        30     30
## 4 D        NA     50
```
]

---

### Chaves Distintas?


```r
data3 &lt;- data2 %&gt;%
          # alterando o nome
          select(chave=nome, everything())

# Join

left_join(data1, data3, 
          by=c("nome"="chave")) # adicione argumento by.
```

```
## # A tibble: 3 x 3
##   nome  value value2
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 A        10     10
## 2 B        20     NA
## 3 C        30     30
```

---

### Desafio

Abre os bancos de dados de candidatos e votos do TSE. Faça um join entre eles, e salve o banco de dados.

- Quantas linhas este novo banco de dados possuí?

- Explique o número de linhas. 


```r
# Banco Candidatos
candidatos &lt;- get_candidates(year=2018, position="President") %&gt;% 
                as_tibble()

# Banco Votos
votos &lt;- get_votes(year = 2018, position="President", state="RJ") %&gt;%
            as_tibble()
# Join? 
```

<div class="countdown" id="timer_603bd895" style="right:0;bottom:0;margin:5%;padding:10px;font-size:3em;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---


## Concatenando Bancos de Dados

Além de juntar bancos de dados usando chaves, podemos concatecar bancos verticalmente (pelas linhas) ou horizontalmente (pelas colunas). 

---

### bind_rows: por linhas


```r
bind_rows(data1, data2)
```

```
## # A tibble: 6 x 3
##   nome  value value2
##   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1 A        10     NA
## 2 B        20     NA
## 3 C        30     NA
## 4 A        NA     10
## 5 D        NA     50
## 6 C        NA     30
```

Note: ao conectar por linha, **as colunas precisam ter os mesmos nomes**. Caso não, você adicionará uma nova variável ao resultado final. 

---

### bind_cols: por colunas


```r
bind_cols(data1, data2)
```

```
## # A tibble: 3 x 4
##   nome...1 value nome...3 value2
##   &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
## 1 A           10 A            10
## 2 B           20 D            50
## 3 C           30 C            30
```

Note: ao conectar por coluna, **as linhas precisam ter tamanho igual**.

---

class: middle, center, inverse

## [Exercicio 3]()


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
